!function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof exports?module.exports=t(require("jquery")):t(jQuery)}(function(t){"use strict";if("undefined"==typeof moment)return alert("请先引入moment.js， http://momentjs.com/"),!1;var e=t({});t.each({trigger:"pubCal",on:"subCal",off:"unsubCal"},function(a,n){t[n]=function(){e[a].apply(e,arguments)}}),window.noshCalendar={today:moment().unix(),deflection:0,locale:{firstDayOfWeek:1,weekdays:["一","二","三","四","五","六","日"],prevMonth:"&laquo;上月",nextMonth:"下月&raquo;",year:"年",month:"月",day:"日",hour:"时",minute:"分",second:"秒",today:"今天"}};var a=function(){};a.prototype.emptyData=function(){return{year:{list:[],selected:""},month:{list:[],selected:""},day:{list:[],selected:""},hour:{list:[],selected:""},minute:{list:[],selected:""},second:{list:[],selected:""}}},a.prototype.cutDatetime=function(t,e){var a=null,n=function(t){return parseInt(a.format(t))};return a="timestamp"!==e?moment(t,e):10===t.toString().length?moment(1e3*t):13===t.toString().length?moment(t):moment(),{year:n("YYYY"),month:n("M")-1,day:n("D"),hour:n("H"),minute:n("m"),second:n("s")}},a.prototype.momentToArray=function(t){var e=t.format("YYYY-M-D").split("-"),a=t.format("H:m:s").split(":"),n=[];return n[0]=+e[0],n[1]=e[1]-1,n[2]=+e[2],n[3]=+a[0],n[4]=+a[1],n[5]=+a[2],n},a.prototype.fillZero=function(t,e){var a="",n=0;e=e?Math.abs(parseInt(e)):1,n=e-t.toString().length+1,t=parseInt(t);for(var r=0;r<n;r++)a+="0";return t<Math.pow(10,e)?a+t:t.toString()},a.prototype.dayNumOfMonth=function(t,e){return 32-new Date(t,e,32).getDate()},a.prototype.today=function(){var t=moment().unix()+window.noshCalendar.deflection;return this.cutDatetime(t,"timestamp")},a.prototype.isToday=function(t){var e=this,a=e.today(),n=moment([a.year,a.month,a.day]);return moment([t.year,t.month,t.day]).isSame(n)},a.prototype.checkIsWeekend=function(t,e,a){var n=moment([t,e,a]).isoWeekday();return 6===n||7===n},a.prototype.checkInRange=function(e){var a=this,n=null;return n=function(){var n=[!0,e,""],r=[],o=a.current.startObject,s=[];return t.isEmptyObject(o)||(s=[o.year],o.month<12&&o.month>0&&s.push(o.month),o.day&&o.day<32&&o.day>0&&s.push(o.day),o.hour&&o.hour<25&&o.hour>0&&s.push(o.hour),o.minute&&o.minute<61&&o.minute>0&&s.push(o.minute),o.second&&o.second<61&&o.second>0&&s.push(o.second),e.length!==s.length?t.each(s,function(t){r[t]=void 0!==e[t]?e[t]:s[t]}):r=e,moment(r).isBefore(moment(s))&&(n[0]=!1,n[1]=[],n[1]=s,n[2]="min")),n}(),!0===n[0]&&(n=function(){var n=[!0,e,""],r=[],o=a.current.endObject,s=[];return t.isEmptyObject(o)||(s=[o.year],o.month<12&&o.month>0&&s.push(o.month),o.day&&o.day<32&&o.day>0&&s.push(o.day),o.hour&&o.hour<25&&o.hour>0&&s.push(o.hour),o.minute&&o.minute<61&&o.minute>0&&s.push(o.minute),o.second&&o.second<61&&o.second>0&&s.push(o.second),e.length!==s.length?t.each(s,function(t){r[t]=void 0!==e[t]?e[t]:s[t]}):r=e,moment(r).isAfter(moment(s))&&(n[0]=!1,n[1]=[],n[1]=s,n[2]="max")),n}()),n},a.prototype.setYearData=function(){var e=this,a="",n="",r=e.current.valueObject.year,o=[];t.isEmptyObject(e.current.startObject)?a=e.current.valueObject.year-30:(a=e.current.startObject.year,r=r<a?a:r),t.isEmptyObject(e.current.endObject)?n=e.current.valueObject.year+30:(n=e.current.endObject.year,r=r>n?n:r);for(var s=a;s<=n;s++)o.push({value:s,disabled:!1,text:s});e.data.year.list=o,e.data.year.selected=r},a.prototype.setMonthData=function(){for(var e=this,a=e.current.valueObject.month,n=[],r=t.isEmptyObject(e.current.startObject)?null:e.current.startObject,o=t.isEmptyObject(e.current.endObject)?null:e.current.endObject,s=0;s<=11;s++)n.push({value:s,disabled:!1,text:e.fillZero(s+1)});if(r&&e.data.year.selected===r.year){for(var c=0;c<r.month;c++)n[c].disabled=!0;a=a<r.month?r.month:a}if(o&&e.data.year.selected===o.year){for(var d=o.month+1;d<=11;d++)n[d].disabled=!0;a=a>o.month?o.month:a}e.data.month.list=n,e.data.month.selected=a},a.prototype.getMonthDays=function(t,e,a){var n=this,r=0===Math.abs(n.current.show),o=n.dayNumOfMonth(t,e),s=moment([t,e,1]).isoWeekday(),c=0,d=0,u={select:n.current.valueObject.day,year:t,month:e,list:[]};c=7===window.noshCalendar.locale.firstDayOfWeek?s:s-1,d=42-c-o;for(var i=0;i<c;i++){var l=n.momentToArray(moment([t,e,1]).subtract(c-i,"days")),h=r?n.fillZero(l[2]):"&nbsp;";u.list.push({index:i,year:l[0],month:l[1],day:l[2],text:h,disabled:!0,checked:!1})}for(var m=1;m<=o;m++){var y=n.momentToArray(moment([t,e,m])),p=m-1+c,f=n.checkInRange([t,e,m]),b=!f[0],v=!(!1!==b||!a||a[0]!==t||a[1]!==e||a[2]!==m);u.list.push({index:p,year:y[0],month:y[1],day:y[2],text:n.fillZero(y[2]),disabled:b,checked:v}),n.isToday({year:t,month:e,day:m})&&(u.list[p].isToday=!0)}for(var O=1;O<=d;O++){var g=n.momentToArray(moment([t,e,o]).add(O,"days")),j=O+c+o,D=r?n.fillZero(g[2]):"&nbsp;";u.list.push({index:j,year:g[0],month:g[1],day:g[2],text:D,disabled:!0,checked:!1})}return u},a.prototype.setDayData=function(e,a){var n=this,r=[],o=[],s=parseInt(Math.abs(n.current.show)),c=null,d=n.current.valueObject.day;if(e=e||n.data.year.selected,a=a||n.data.month.selected,c=n.checkInRange([n.data.year.selected,n.data.month.selected,d])[1],o.push([e,a]),s>0)for(var u=1;u<=s;u++){var i=n.momentToArray(moment([e,a,1]).subtract(u,"months")),l=n.momentToArray(moment([e,a,1]).add(u,"months"));o.unshift([i[0],i[1]]),o.push([l[0],l[1]])}t.each(o,function(){var t=arguments[1];r.push(n.getMonthDays(t[0],t[1],c))}),d=c[2],n.data.day.list=r,n.data.day.selected=d},a.prototype.setHourData=function(){for(var e=this,a=e.current.valueObject.hour,n=[],r=t.isEmptyObject(e.current.startObject)?null:e.current.startObject,o=t.isEmptyObject(e.current.endObject)?null:e.current.endObject,s=moment([e.data.year.selected,e.data.month.selected,e.data.day.selected]),c=0;c<=23;c++)n.push({value:c,disabled:!1,text:e.fillZero(c)});if(r&&s.isSame([r.year,r.month,r.day])){for(var d=0;d<r.hour-0;d++)n[d].disabled=!0;a=a<r.hour?r.hour:a}if(o&&s.isSame([o.year,o.month,o.day])){for(var u=o.hour+1;u<=23;u++)n[u].disabled=!0;a=a>o.hour?o.hour:a}e.data.hour.list=n,e.data.hour.selected=a},a.prototype.setMinuteData=function(){for(var e=this,a=e.current.valueObject.minute,n=[],r=t.isEmptyObject(e.current.startObject)?null:e.current.startObject,o=t.isEmptyObject(e.current.endObject)?null:e.current.endObject,s=moment([e.data.year.selected,e.data.month.selected,e.data.day.selected,e.data.hour.selected]),c=0;c<=59;c++)n.push({value:c,disabled:!1,text:e.fillZero(c)});if(r&&s.isSame([r.year,r.month,r.day,r.hour])){for(var d=0;d<r.minute-0;d++)n[d].disabled=!0;a=a<r.minute?r.minute:a}if(o&&s.isSame([o.year,o.month,o.day,o.hour])){for(var u=o.minute+1;u<=59;u++)n[u].disabled=!0;a=a>o.minute?o.minute:a}e.data.minute.list=n,e.data.minute.selected=a},a.prototype.setSecondData=function(){for(var e=this,a=e.current.valueObject.second,n=[],r=t.isEmptyObject(e.current.startObject)?null:e.current.startObject,o=t.isEmptyObject(e.current.endObject)?null:e.current.endObject,s=moment([e.data.year.selected,e.data.month.selected,e.data.day.selected,e.data.hour.selected,e.data.minute.selected]),c=0;c<=59;c++)n.push({value:c,disabled:!1,text:e.fillZero(c)});if(r&&s.isSame([r.year,r.month,r.day,r.hour,r.minute])){for(var d=0;d<r.second-0;d++)n[d].disabled=!0;a=a<r.second?r.second:a}if(o&&s.isSame([o.year,o.month,o.day,o.hour,o.minute])){for(var u=o.second+1;u<=59;u++)n[u].disabled=!0;a=a>o.second?o.second:a}e.data.second.list=n,e.data.second.selected=a},a.prototype.getData=function(){return this.data},a.prototype.getCurrent=function(){return this.current},a.prototype.resetData=function(){this.data=t.extend(!0,{},this.emptyData()||{}),this.box.empty()},a.prototype.checkIsInit=function(){var e=this.box;return void 0===e&&(this.box=null,this.data=t.extend(!0,{},this.emptyData()||{}),this.current=null,this.display="normal"),!(!e||!e[0])},a.prototype.initCurrent=function(e){var a=this,n=moment(1e3*window.noshCalendar.today),r=null,o={input:null,width:430,value:n.format("YYYY-MM-DD HH:mm:ss"),start:"",end:"",show:0,footer:!0,format:"YYYY-MM-DD HH:mm:ss"};return a.current=t.extend(!0,o,e||{}),r=moment(a.today()).format(a.current.format),"today"===a.current.start&&(a.current.start=r),"today"===a.current.end&&(a.current.end=r),/#/.test(a.current.start)&&t(a.current.start).length>0&&(a.current.start=t(a.current.start).val(),a.current.start=a.current.start?a.current.start:r),/#/.test(a.current.end)&&t(a.current.end).length>0&&(a.current.end=t(a.current.end).val(),a.current.end=a.current.end?a.current.end:r),a.current.value=a.current.value?a.current.value:n.format(a.current.format),a.current.valueObject=a.cutDatetime(a.current.value,a.current.format,123),a.current.startObject=a.current.start?a.cutDatetime(a.current.start,a.current.format):null,a.current.endObject=a.current.end?a.cutDatetime(a.current.end,a.current.format):null,t.pubCal("initCurrent",a.current),a.current},a.prototype.init=function(e,a){var n=this;if(e&&(window.noshCalendar.deflection=e-moment().unix()),a=a||"nosh-calendar",!1===n.checkIsInit()){var r=null;"nosh-calendar"===a?(r=t('<div class="nosh-calendar" id="'+a+'"></div>'),r.appendTo("body")):(r=t("#"+a),n.display="inline"),n.box=r,r.on("change",".nosh-year",function(){var e=t(this).val();n.change({year:e})}),r.on("change",".nosh-month",function(){var e=t(this).val();n.change({month:e})}),r.on("click","td",function(){var e=t(this),a=Number(e.data("col")),r=Number(e.data("index"));if(!e.hasClass("disabled")&&!e.hasClass("selected")){var o=n.data.day.list[a];n.change({year:o.year,month:o.month,day:o.list[r].day})}return!0!==n.current.footer&&(n.current.input.val(n.getVal()).trigger("change"),n.closed()),!1}),r.on("change",".nosh-hour",function(){var e=t(this).val();n.change({hour:e})}),r.on("change",".nosh-minute",function(){var e=t(this).val();n.change({minute:e})}),r.on("change",".nosh-second",function(){var e=t(this).val();n.change({second:e})}),r.on("click",".nosh-prev, .nosh-next",function(){var e=t(this).hasClass("nosh-prev")?-1:1,a=n.data.year.selected,r=n.data.month.selected+e;return 12===r?(a+=1,r=0):-1===r&&(a-=1,r=11),n.change({year:a,month:r}),!1}),r.on("click",".nosh-confirm",function(){var e=n.getVal();return t.pubCal("confirm",[n.current,e]),n.current.input.val(e).trigger("change"),n.closed(),!1}),r.on("click",".nosh-set-today",function(){var e=n.today();return n.change(e),t.pubCal("confirmToday",[n.current,e]),n.current.input.val(n.getVal()).trigger("change"),n.closed(),!1}),"inline"!==n.display&&(t(document).on("click.noshCalendar",function(e){var a=t(e.target);!n.current||a.is(n.current.input)||a.hasClass("nosh-calendar")||0!==a.closest(".nosh-calendar").length||n.box.is(":hidden")||n.closed()}),t(document).on("keyup",function(t){27===Number(t.keyCode)&&n.closed()})),t.pubCal("init",n.box)}},a.prototype.numberSelectOptions=function(t,e){for(var a="",n=0;n<t.length;n++){var r=t[n],o=r.disabled?' disabled="disabled"':"",s=Number(r.value)===e?' selected="selected"':"";a+='<option value="'+r.value+'"'+s+o+">"+r.text+"</option>"}return a},a.prototype.header=function(){var t=window.noshCalendar.locale,e=this;return'<div class="nosh-header">    <div class="header-content">        <label class="year">            <select class="nosh-year">'+e.numberSelectOptions(e.data.year.list,e.data.year.selected)+"            </select> "+t.year+'        </label>        <label class="month">            <select class="nosh-month">'+e.numberSelectOptions(e.data.month.list,e.data.month.selected)+"            </select> "+t.month+'        </label>    </div>    <a href="javascript:;" class="nosh-prev">'+t.prevMonth+'</a>    <a href="javascript:;" class="nosh-next">'+t.nextMonth+"</a></div>"},a.prototype.footer=function(){var t=window.noshCalendar.locale,e=this,a='\n<li>    <label>        <select class="nosh-minute">'+e.numberSelectOptions(e.data.minute.list,e.data.minute.selected)+"        </select> "+t.minute+"    </label></li>\n",n='\n<li>    <label>        <select class="nosh-second">'+e.numberSelectOptions(e.data.second.list,e.data.second.selected)+"        </select> "+t.second+"    </label></li>\n";return!1===/m/.test(e.current.format)&&(a=""),!1===/s/.test(e.current.format)&&(n=""),'<div class="nosh-footer">    <ul>        <li class="day nosh-selected-day">'+e.data.year.selected+t.year+e.fillZero(e.data.month.selected+1)+t.month+e.fillZero(e.data.day.selected)+t.day+'</li>        <li>            <label>                <select class="nosh-hour">'+e.numberSelectOptions(e.data.hour.list,e.data.hour.selected)+"                </select> "+t.hour+"            </label>        </li>"+a+n+'        <li class="btns">            <button type="button" class="nosh-confirm">确定</button>        </li>        <li class="btns-today">            <button type="button" class="nosh-set-today">今天</button>        </li>    </ul></div>'},a.prototype.days=function(e,a){var n=this,r="",o="",s=window.noshCalendar.locale,c=100/(2*n.current.show+1),d=n.current.show>0?'<tr><th colspan="7">'+a.year+s.year+(a.month+1)+s.month+"</th></tr>":"";return t.each(s.weekdays,function(t){r+="<th>"+s.weekdays[t]+"</th>"}),r="<thead>"+d+"<tr>"+r+"</tr></thead>",t.each(e,function(t,e){var r=e.checked?" selected":"",s=e.disabled?" disabled":"",c="",d="",u=n.checkIsWeekend(e.year,e.month,e.day)?" weekend":"",i=e.isToday?" today":"";c=t%7==0?"<tr>":"",d=t%7==6?"</tr>":"",o+=c+'<td class="'+r+s+u+i+'" data-col="'+a.index+'" data-index="'+e.index+'" data-day="'+e.year+"-"+(e.month+1)+"-"+e.day+'">'+e.text+"</td>"+d}),'<div class="nosh-days" data-index="'+a.index+'" data-year="'+a.year+'" data-month="'+a.month+'" style="width: '+c+'%;"><table>'+r+"<tbody>"+o+"</tbody></table></div>"},a.prototype.body=function(){var e=this,a="",n=e.current.width*(2*e.current.show+1);return t.each(e.data.day.list,function(t){var n=e.data.day.list[t];a+=e.days(n.list,{year:n.year,month:n.month,index:t})}),a='<div class="nosh-body" style="width: '+n+'px;">'+a+"</div>"},a.prototype.show=function(e,a){var n=this,r="",o="",s="",c="",d="auto";n.initCurrent(e),n.setYearData(),n.setMonthData(),n.setDayData(),n.setHourData(),n.setMinuteData(),n.setSecondData(),n.dataFilter&&t.isFunction(n.dataFilter)&&(n.data=t.extend(!0,n.data,n.dataFilter(n.getData())||n.emptyData())),d=n.current.width*(2*n.current.show+1),s=n.header(),o=n.body(),!0===n.current.footer&&(c=n.footer()),a.width=d,r=s+o+c,n.box.css(a).html(r).show(),t.pubCal("show",[n.box,n.current,n.data])},a.prototype.closed=function(){var e=this;if("inline"!==e.display){var a=e.current.input;e.box.empty().hide(),e.resetData(),e.current=null,t.pubCal("closed",a)}},a.prototype.change=function(e){var a=this,n="",r="",o="",s="";a.resetData(),t.each(e,function(t,e){a.current.valueObject[t]=Number(e)}),a.setYearData(),a.setMonthData(),a.setDayData(),a.setHourData(),a.setMinuteData(),a.setSecondData(),a.dataFilter&&t.isFunction(a.dataFilter)&&(a.data=t.extend(!0,a.data,a.dataFilter(a.getData())||a.emptyData())),o=a.header(),r=a.body(),!0===a.current.footer&&(s=a.footer()),n=o+r+s,a.box.html(n),t.pubCal("change",[a.box,a.current,e,a.data])},a.prototype.getVal=function(){return moment(this.current.valueObject).format(this.current.format)},a.prototype.dataFilter=null,window.noshCalendar.c=a,window.noshCalendar.i=new a,t.fn.noshCalendar=function(e){var a=this,n=window.noshCalendar.i;return n.init(),t.each(a,function(){var a=t(this);a.on("focus.noshCalendar",function(){var r=a.data(),o=a.offset(),s={left:o.left,top:o.top+a.outerHeight()};r=t.extend(!0,e||{},r),r.input=a,r.value=a.val(),n.show(r,s)})}),this}});
